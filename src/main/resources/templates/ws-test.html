<!DOCTYPE html>
  <html xmlns:th="http://www.thymeleaf.org">
  <head>
      <meta charset="UTF-8">
      <title>WebSocket 테스트</title>
      <style>
          body {
              font-family: Arial, sans-serif;
              max-width: 800px;
              margin: 50px auto;
              padding: 20px;
          }
          #messages {
              border: 1px solid #ccc;
              height: 300px;
              overflow-y: scroll;
              padding: 10px;
              margin: 20px 0;
              background: #f9f9f9;
          }
          .message {
              padding: 5px;
              margin: 5px 0;
              border-bottom: 1px solid #eee;
          }
          .connected { color: green; }
          .disconnected { color: red; }
          input, button {
              padding: 10px;
              font-size: 16px;
          }
          button {
              background: #007bff;
              color: white;
              border: none;
              cursor: pointer;
          }
          button:hover {
              background: #0056b3;
          }
      </style>
  </head>
  <body>
      <h3>WebSocket 실시간 통신 테스트</h3>

      <div>
          <button id="connectBtn" onclick="connect()">연결</button>
          <button id="disconnectBtn" onclick="disconnect()" disabled>연결 해제</button>
          <span id="status" class="disconnected">● 연결 안됨</span>
      </div>

      <div style="margin: 20px 0;">
          <input type="text" id="messageInput" placeholder="메시지 입력..." style="width: 70%;">
          <button onclick="sendMessage()">전송</button>
      </div>

      <div id="messages"></div>

      <!-- SockJS + STOMP 라이브러리 -->
      <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

      <script>
          let stompClient = null;

          // WebSocket 연결
          function connect() {
              const socket = new SockJS('/ws');  // WebSocketConfig의 엔드포인트
              stompClient = Stomp.over(socket);

              stompClient.connect({}, function(frame) {
                  console.log('연결 성공: ' + frame);

                  // 상태 업데이트
                  document.getElementById('status').textContent = '연결됨';
                  document.getElementById('status').className = 'connected';
                  document.getElementById('connectBtn').disabled = true;
                  document.getElementById('disconnectBtn').disabled = false;

                  // /topic/test 구독 시작
                  stompClient.subscribe('/topic/test', function(message) {
                      showMessage(message.body);
                  });

                  showMessage('[시스템] WebSocket 연결 성공');
              }, function(error) {
                  console.error('연결 실패:', error);
                  showMessage('[에러] 연결 실패: ' + error);
              });
          }

          // WebSocket 연결 해제
          function disconnect() {
              if (stompClient !== null) {
                  stompClient.disconnect();
              }
              document.getElementById('status').textContent = '연결 안됨';
              document.getElementById('status').className = 'disconnected';
              document.getElementById('connectBtn').disabled = false;
              document.getElementById('disconnectBtn').disabled = true;
              showMessage('[시스템] 연결 해제됨');
          }

          // 메시지 전송
          function sendMessage() {
              const input = document.getElementById('messageInput');
              const message = input.value.trim();

              if (!message) {
                  alert('메시지를 입력하세요!');
                  return;
              }

              if (stompClient === null || !stompClient.connected) {
                  alert('먼저 연결 버튼을 눌러주세요!');
                  return;
              }

              // /app/test/{message} 로 전송
              stompClient.send("/app/test/" + message, {}, '');
              showMessage('[나] ' + message);
              input.value = '';
          }

          // 화면에 메시지 표시
          function showMessage(message) {
              const messagesDiv = document.getElementById('messages');
              const messageElement = document.createElement('div');
              messageElement.className = 'message';
              messageElement.textContent = message;
              messagesDiv.appendChild(messageElement);
              messagesDiv.scrollTop = messagesDiv.scrollHeight;  // 자동 스크롤
          }

          // 엔터키로 전송
          document.getElementById('messageInput').addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                  sendMessage();
              }
          });
      </script>
  </body>
  </html>
