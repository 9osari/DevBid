<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${auction.productName} + ' - 경매 상세'">경매 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link href="/css/theme.css" rel="stylesheet">
</head>
<body>

<div class="container mt-4">
    <h1 th:text="${auction.productName}">상품명</h1>

    <div class="row mt-4">
        <!-- 좌측: 상품 정보 -->
        <div class="col-lg-6">
            <h3>Product Info</h3>
            <div class="info-box">
                <!-- 메인 이미지 -->
                <div class="mb-3">
                    <img th:if="${auction.mainImageUrl() != null}"
                         th:src="${auction.mainImageUrl()}"
                         alt="상품 메인 이미지"
                         style="width: 100%; max-height: 400px; object-fit: contain; border: 1px solid #888;">
                    <div th:unless="${auction.mainImageUrl() != null}" class="placeholder-box">
                        [이미지 없음]
                    </div>
                </div>

                <!-- 서브 이미지들 (메인 이미지 포함) -->
                <div th:if="${auction.mainImageUrl() != null or (auction.subImageUrls() != null and !auction.subImageUrls().isEmpty())}"
                     class="d-flex gap-2 mb-3" style="overflow-x: auto;">
                    <!-- 메인 이미지 썸네일 추가 -->
                    <img th:if="${auction.mainImageUrl() != null}"
                         th:src="${auction.mainImageUrl()}"
                         alt="메인 이미지"
                         style="width: 80px; height: 80px; object-fit: cover; border: 2px solid #000; cursor: pointer;"
                         onclick="changeMainImage(this.src)"
                         title="메인 이미지">

                    <!-- 서브 이미지들 -->
                    <img th:each="subImageUrl : ${auction.subImageUrls()}"
                         th:src="${subImageUrl}"
                         alt="상품 서브 이미지"
                         style="width: 80px; height: 80px; object-fit: cover; border: 1px solid #888; cursor: pointer;"
                         onclick="changeMainImage(this.src)">
                </div>


                <p><strong>상품명:</strong> <span th:text="${auction.productName}">상품명</span></p>
                <hr>
                <p><strong>상품 상세 설명</strong></p>
                <div style="max-height: 250px; overflow-y:auto; border:1px solid #ccc; padding:8px; background:#fff;">
                    <p th:utext="${auction.description}">
                        상품 상세 설명이 여기에 표시됩니다.
                    </p>
                </div>
                <hr>
                <!-- 판매자 정보 -->
                <div class="user-info-box seller-box">
                    <div class="user-details">
                        <div class="user-label">판매자</div>
                        <p class="user-name" th:text="${auction.sellerName()}">판매자</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 우측: 경매 정보 -->
        <div class="col-lg-6">
            <h3>Auction Info</h3>
            <div class="auction-section">
                <p><strong>경매 상태:</strong>
                    <span id="auctionStatus" th:text="${auction.status}">ONGOING</span>
                </p>

                <!-- 현재 최고 입찰자 정보 -->
                <div class="user-info-box bidder-box"
                     th:if="${auction.winnerName() != null and !auction.winnerName().isEmpty()}">
                    <div class="user-details">
                        <div class="user-label">최고 입찰자</div>
                        <p class="user-name" id="winnerName" th:text="${auction.winnerName()}">입찰자</p>
                    </div>
                </div>

                <!-- 입찰자가 없는 경우 -->
                <div class="user-info-box"
                     th:unless="${auction.winnerName() != null and !auction.winnerName().isEmpty()}">
                    <div class="user-details">
                        <div class="user-label">최고 입찰자</div>
                        <p class="user-name no-bidder" id="winnerName">아직 입찰자가 없습니다</p>
                    </div>
                </div>

                <hr>

                <p><strong>현재 입찰가:</strong>
                    <span class="price"
                          th:text="${#numbers.formatDecimal(auction.currentPrice, 0, 'COMMA', 0, 'POINT')} + '원'">1,000,000원</span>
                </p>
                <p><strong>시작 가격:</strong>
                    <span th:text="${#numbers.formatDecimal(auction.startingPrice, 0, 'COMMA', 0, 'POINT')} + '원'">100,000원</span>
                </p>
                <p><strong>즉시 구매가:</strong>
                    <span class="text-success"
                          th:text="${#numbers.formatDecimal(auction.buyoutPrice, 0, 'COMMA', 0, 'POINT')} + '원'">2,000,000원</span>
                </p>
                <p><strong>입찰 횟수:</strong> <span id="bidCount" th:text="${auction.bidCount}">0</span> 회</p>

                <hr>
                <p><strong>시작 시간:</strong>
                    <span th:text="${#temporals.format(auction.startTime, 'yyyy-MM-dd HH:mm')}"></span></p>
                <p><strong>종료 시간:</strong>
                    <span id="endTime" th:text="${#temporals.format(auction.endTime, 'yyyy-MM-dd HH:mm')}"></span>

                <!-- 카운트다운 타이머 -->
                <div id="countdown-container" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
                     padding: 15px; margin: 15px 0; border-radius: 8px; text-align: center;
                     box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="color: #fff; font-size: 12px; font-weight: bold; letter-spacing: 1px; margin-bottom: 5px;">
                        ⏰ TIME REMAINING
                    </div>
                    <div id="countdown"
                         style="color: #fff; font-size: 28px; font-weight: bold; font-family: 'Courier New', monospace; letter-spacing: 2px;">
                        계산 중...
                    </div>
                    <div id="countdown-status" style="color: #ffe0e0; font-size: 11px; margin-top: 5px;">
                    </div>
                </div>

                <hr>
                <form th:action="@{/auctions/bid/{auctionId}(auctionId=${auction.id})}" method="post" id="bidForm">
                    <label><strong>입찰가 입력:</strong></label>
                    <input type="text" name="bidAmount" id="bidAmountInput" oninput="formatNumberInput(this)"
                           th:placeholder="${#numbers.formatDecimal(auction.currentPrice + 100, 0, 'COMMA', 0, 'POINT')} + '원 이상'"
                           required
                           style="width:100%; padding: 8px; margin: 10px 0; font-size: 16px; border: 2px solid #ccc;">

                    <!-- 빠른 입찰 버튼들 -->
                    <div style="display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap;">
                        <button type="button" class="quick-bid-btn" onclick="setQuickBid(10000, event)"
                                style="flex: 1; min-width: 80px; padding: 8px; background: #e3f2fd; border: 1px solid #2196F3;
                                       color: #1976D2; font-size: 12px; cursor: pointer; border-radius: 4px;">
                            +1만원
                        </button>
                        <button type="button" class="quick-bid-btn" onclick="setQuickBid(50000, event)"
                                style="flex: 1; min-width: 80px; padding: 8px; background: #e3f2fd; border: 1px solid #2196F3;
                                       color: #1976D2; font-size: 12px; cursor: pointer; border-radius: 4px;">
                            +5만원
                        </button>
                        <button type="button" class="quick-bid-btn" onclick="setQuickBid(100000, event)"
                                style="flex: 1; min-width: 80px; padding: 8px; background: #e3f2fd; border: 1px solid #2196F3;
                                       color: #1976D2; font-size: 12px; cursor: pointer; border-radius: 4px;">
                            +10만원
                        </button>
                        <button type="button" class="quick-bid-btn" onclick="setQuickBid(500000, event)"
                                style="flex: 1; min-width: 80px; padding: 8px; background: #e3f2fd; border: 1px solid #2196F3;
                                       color: #1976D2; font-size: 12px; cursor: pointer; border-radius: 4px;">
                            +50만원
                        </button>
                    </div>

                    <input type="submit" value="Place Bid"
                           style="width: 100%; padding: 12px; font-size: 16px; font-weight: bold;
                                  background: #4CAF50; color: white; border: none; border-radius: 4px;
                                  cursor: pointer;">
                </form>

                <!-- 즉시구매 버튼 (모달 트리거) -->
                <button type="button" class="mt-3" data-bs-toggle="modal" data-bs-target="#buyoutModal"
                        style="width: 100%; padding: 12px; font-size: 16px; font-weight: bold;
                               background: #FF5722; color: white; border: none; border-radius: 4px;
                               cursor: pointer;">
                    Buy Now
                </button>
            </div>
        </div>
    </div>

    <div class="text-center mt-4">
        <a href="/" class="btn btn-outline-secondary">홈으로</a>
    </div>
</div>

<!-- 즉시구매 확인 모달 -->
<div class="modal fade" id="buyoutModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Buy Now</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">
                    Would you like to buy <strong th:text="${auction.productName}">Product Name</strong> now?
                </p>
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #FF5722;">
                    <p class="mb-2"><strong>Buy Now Price</strong></p>
                    <p class="mb-0" style="font-size: 24px; font-weight: bold; color: #FF5722;">
                        <span th:text="${#numbers.formatDecimal(auction.buyoutPrice, 0, 'COMMA', 0, 'POINT')}">0</span>원
                    </p>
                </div>
                <p class="text-warning-custom small mt-3">Buying now will end the auction.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>

                <form th:action="@{/auctions/{auctionId}/buyout(auctionId=${auction.id})}" method="post"
                      class="d-inline">
                    <button type="submit" class="btn btn-danger" style="background: #FF5722; border-color: #FF5722;">
                        Buy Now
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function changeMainImage(src) {
        const mainImg = document.querySelector('img[alt="상품 메인 이미지"]');
        if (mainImg) {
            mainImg.src = src;
        }
    }

    const currentPrice = Number(/*[[${auction.currentPrice}]]*/ 0);

    // 빠른 입찰 버튼 클릭 시
    function setQuickBid(amount, event) {
        const input = document.getElementById('bidAmountInput');
        let currentValue = Number(input.value.replace(/,/g, '')) || currentPrice;
        const newValue = currentValue + amount;

        // 콤마 포맷 적용
        input.value = newValue.toLocaleString('ko-KR');

        // 버튼 클릭 효과
        event.target.style.transform = 'scale(0.95)';
        setTimeout(() => {
            event.target.style.transform = 'scale(1)';
        }, 100);
    }

    // 숫자에 콤마 추가
    function formatNumberInput(input) {
        let value = input.value.replace(/,/g, ''); // 콤마 제거
        if (value && !isNaN(value)) {
            input.value = Number(value).toLocaleString('ko-KR');
        }
    }

    document.getElementById('bidForm').addEventListener('submit', function(e) {
        const input = document.getElementById('bidAmountInput');
        // 콤마 제거하고 순수 숫자만 남김
        input.value = input.value.replace(/,/g, '');
    });

    // 카운트다운 타이머
    function startCountdown() {
        const endTimeStr = '[[${auction.endTime}]]';
        if (!endTimeStr) return;

        const endTime = new Date(endTimeStr).getTime();
        const countdownElement = document.getElementById('countdown');
        const containerElement = document.getElementById('countdown-container');
        const statusElement = document.getElementById('countdown-status');

        function updateCountdown() {
            const now = new Date().getTime();
            const distance = endTime - now;

            if (distance < 0) {
                countdownElement.innerHTML = "Auction Ended..";
                statusElement.innerHTML = "Bidding has closed";
                containerElement.style.background = "linear-gradient(135deg, #757575 0%, #616161 100%)";
                clearInterval(countdownInterval);

                // 버튼들 비활성화
                disableAuctionButtons();
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            // 시간 포맷팅
            let timeString = '';
            if (days > 0) {
                timeString = `${days}d ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                statusElement.innerHTML = "Plenty of time remaining.";
            } else if (hours > 0) {
                timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                if (hours < 3) {
                    containerElement.style.background = "linear-gradient(135deg, #ff9800 0%, #f57c00 100%)";
                    statusElement.innerHTML = "Closing soon!";
                } else {
                    statusElement.innerHTML = "Place your bid now!";
                }
            } else {
                timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                containerElement.style.background = "linear-gradient(135deg, #f44336 0%, #d32f2f 100%)";
                statusElement.innerHTML = "Ending soon.";

                // 1분 미만일 때 깜빡임 효과
                if (minutes < 1) {
                    countdownElement.style.animation = 'blink 1s infinite';
                    statusElement.innerHTML = "Final chance!";
                }
            }

            countdownElement.innerHTML = timeString;
        }

        // 즉시 실행
        updateCountdown();

        // 1초마다 업데이트
        countdownInterval = setInterval(updateCountdown, 1000);
    }

    // 깜빡임 애니메이션을 위한 스타일 추가
    const style = document.createElement('style');
    style.textContent = `
        @keyframes blink {
            0%, 50% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }
        .quick-bid-btn:hover {
            background: #2196F3 !important;
            color: white !important;
            transform: translateY(-2px);
            transition: all 0.2s;
        }
        input[type="submit"]:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            transition: all 0.2s;
        }
    `;
    document.head.appendChild(style);

    // 웹소켓 연결 및 구독
    let stompClient = null;
    let countdownInterval = null;  // 카운트다운 interval 전역 변수

    // 페이지 로드 시 실행
    window.addEventListener('DOMContentLoaded', function() {
        checkAuctionStatus();  // 경매 상태 체크
        startCountdown();
        connectWebSocket();
    });

    // 경매 상태 체크
    function checkAuctionStatus() {
        const statusStr = '[[${auction.status}]]';
        const endTimeStr = '[[${auction.endTime}]]';

        // 서버에서 이미 ENDED 상태로 로드되었다면
        if (statusStr === 'ENDED') {
            disableAuctionButtons();
            return;
        }

        // 시간이 지났다면
        const endTime = new Date(endTimeStr).getTime();
        const now = new Date().getTime();

        if (now >= endTime) {
            disableAuctionButtons();
        }
    }

    // Auction Ended 버튼 비활성화
    function disableAuctionButtons() {
        // 입찰 input 비활성화
        const bidInput = document.getElementById('bidAmountInput');
        if (bidInput) {
            bidInput.disabled = true;
            bidInput.style.background = '#f5f5f5';
            bidInput.placeholder = 'The auction has ended...';
        }

        // 빠른 입찰 버튼들 비활성화
        document.querySelectorAll('.quick-bid-btn').forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
        });

        // 입찰하기 버튼 비활성화
        const submitBtn = document.querySelector('input[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.value = 'Auction Ended..';
            submitBtn.style.background = '#9e9e9e';
            submitBtn.style.cursor = 'not-allowed';
        }

        // 즉시구매 버튼 비활성화
        const buyoutBtn = document.querySelector('button[data-bs-target="#buyoutModal"]');
        if (buyoutBtn) {
            buyoutBtn.disabled = true;
            buyoutBtn.textContent = 'Auction Ended..';
            buyoutBtn.style.background = '#9e9e9e';
            buyoutBtn.style.cursor = 'not-allowed';
            buyoutBtn.removeAttribute('data-bs-toggle');
            buyoutBtn.removeAttribute('data-bs-target');
        }
    }

    function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('WebSocket 연결 성공');

            // 현재 경매의 토픽 구독
            const auctionId = [[${auction.id}]];
            stompClient.subscribe('/topic/auctions/' + auctionId, function (message) {
                const event = JSON.parse(message.body);

                if (event.eventType === 'BUY_OUT') {
                    handleBuyOutEvent(event);
                } else {
                    updateAuctionInfo(event);
                }
            });
        });
    }

    // 입찰 정보 실시간 업데이트
    function updateAuctionInfo(bidEvent) {
        // 현재가 업데이트
        document.querySelector('.price').textContent = bidEvent.currentPrice.toLocaleString('ko-KR') + '원';

        // 최고 입찰자 업데이트
        document.getElementById('winnerName').textContent = bidEvent.bidderName;

        // 입찰 횟수 업데이트
        document.getElementById('bidCount').textContent = bidEvent.bidCount;

        const bidInput = document.getElementById('bidAmountInput');
        const minBidAmount = bidEvent.currentPrice + 100;
        bidInput.placeholder = minBidAmount.toLocaleString('ko-KR') + '원 이상';

        window.currentPrice = bidEvent.currentPrice;
    }

    //즉시구매 웹소켓
    function handleBuyOutEvent(event) {
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }

        // 경매 상태
        document.getElementById('auctionStatus').textContent = 'ENDED';

        // 최고 입찰자
        document.getElementById('winnerName').textContent = event.bidderName;

        // 현재가
        document.querySelector('.price').textContent = event.currentPrice.toLocaleString('ko-KR') + '원';

        // 카운트다운 종료
        document.getElementById('countdown').innerHTML = "Auction Completed!";
        document.getElementById('countdown-status').innerHTML = "The auction has ended...";
        document.getElementById('countdown-container').style.background = "linear-gradient(135deg, #FF5722 0%, #E64A19 100%)";

        if (event.timestamp) {
            const buyoutTime = new Date(event.timestamp);
            document.getElementById('endTime').textContent = buyoutTime.getFullYear() + '-' +
                String(buyoutTime.getMonth() + 1).padStart(2, '0') + '-' +
                String(buyoutTime.getDate()).padStart(2, '0') + ' ' +
                String(buyoutTime.getHours()).padStart(2, '0') + ':' +
                String(buyoutTime.getMinutes()).padStart(2, '0');
        }

        // 버튼들 비활성화
        disableAuctionButtons();
    }
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>