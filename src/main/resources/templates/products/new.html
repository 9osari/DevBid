<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Product Register</title>
  <link href="/css/theme.css" rel="stylesheet">
</head>
<body>
<h2>Product Register</h2>
<form action="/products/new" method="post" enctype="multipart/form-data">
  <table>
    <!-- 상품 정보 -->
    <tr>
      <th colspan="2">Product Information</th>
    </tr>
    <tr>
      <th><label for="productName">Product Name *</label></th>
      <td><input type="text" id="productName" name="productName" required></td>
    </tr>
    <tr>
      <th><label for="description">Description</label></th>
      <td><textarea id="description" name="description" rows="4" cols="40"></textarea></td>
    </tr>
    <tr>
      <th>Category *</th>
      <td>
        <select id="mainCategory" required>
          <option value="">-- 대분류 선택 --</option>
          <!-- 서버에서 대분류 데이터 삽입 -->
        </select>
        <select id="midCategory" disabled>
          <option value="">-- 중분류 선택 --</option>
        </select>
        <select id="subCategory" name="categoryId" disabled required>
          <option value="">-- 소분류 선택 --</option>
        </select>
        <div style="font-size:11px; color:#666;">* 대분류 → 중분류 → 소분류 순서로 선택</div>
      </td>
    </tr>
    <tr>
      <th><label for="condition">Condition *</label></th>
      <td>
        <select id="condition" name="condition" required>
          <option value="">-- 상태 선택 --</option>
          <option value="PRISTINE">PRISTINE (새 상품)</option>
          <option value="WORN">WORN (사용감 있음)</option>
          <option value="DAMAGED">DAMAGED (손상 있음)</option>
          <option value="BADLY_DAMAGED">BADLY_DAMAGED (심하게 손상)</option>
          <option value="RUINED">RUINED (파손)</option>
        </select>
      </td>
    </tr>
    <tr>
      <th><label for="mainImage">Main Image</label></th>
      <td>
        <input type="file" id="mainImage" accept="image/*">
        <input type="hidden" name="mainImageKey">
        <div style="font-size:11px; color:#666;">* 선택사항. JPG, PNG, GIF (최대 10MB)</div>
      </td>
    </tr>
    <tr>
      <th><label for="subImages">Sub Images</label></th>
      <td>
        <input type="file" id="subImages" accept="image/*" multiple>
        <div id="subImageKeysContainer"></div>
        <div style="font-size:11px; color:#666;">* 선택사항. 최대 4장 (sortOrder: 2,3,4,5)</div>
      </td>
    </tr>

  </table>

  <br>
  <input type="submit" value="Submit" />
  <input type="reset" value="Reset" />
</form>

<p><a href="/product/list">Back to Product List</a></p>
<p><a href="/">Home</a></p>

<script th:inline="javascript">
  const categories = /*[[${categoryDtoList}]]*/ [];
  console.log(categories);
  
  // 카테고리 셀렉트박스
  const mainSelect = document.getElementById('mainCategory');
  const midSelect = document.getElementById('midCategory');
  const subSelect = document.getElementById('subCategory');
  
  // 1. 대분류 옵션 채우기
  categories.forEach(category => {
    const option = document.createElement('option');
    option.value = category.id;
    option.textContent = category.name;
    mainSelect.appendChild(option);
  });
  
  // 2. 대분류 선택 시
  mainSelect.addEventListener('change', function() {
    // 중분류, 소분류 초기화
    midSelect.innerHTML = '<option value="">-- 중분류 선택 --</option>';
    subSelect.innerHTML = '<option value="">-- 소분류 선택 --</option>';
    subSelect.disabled = true;
    
    const selectedId = parseInt(this.value);
    if (!selectedId) {
      midSelect.disabled = true;
      return;
    }
    
    // 선택된 대분류 찾기
    const selectedCategory = categories.find(c => c.id === selectedId);
    
    // 중분류 옵션 채우기
    if (selectedCategory && selectedCategory.children.length > 0) {
      midSelect.disabled = false;
      selectedCategory.children.forEach(child => {
        const option = document.createElement('option');
        option.value = child.id;
        option.textContent = child.name;
        midSelect.appendChild(option);
      });
    } else {
      midSelect.disabled = true;
    }
  });
  
  // 3. 중분류 선택 시
  midSelect.addEventListener('change', function() {
    // 소분류 초기화
    subSelect.innerHTML = '<option value="">-- 소분류 선택 --</option>';
    
    const selectedMidId = parseInt(this.value);
    if (!selectedMidId) {
      subSelect.disabled = true;
      return;
    }
    
    const selectedMainId = parseInt(mainSelect.value);
    const mainCategory = categories.find(c => c.id === selectedMainId);
    const midCategory = mainCategory.children.find(c => c.id === selectedMidId);
    
    // 소분류 옵션 채우기
    if (midCategory && midCategory.children.length > 0) {
      subSelect.disabled = false;
      midCategory.children.forEach(child => {
        const option = document.createElement('option');
        option.value = child.id;
        option.textContent = child.name;
        subSelect.appendChild(option);
      });
    } else {
      subSelect.disabled = true;
    }
  });
  
  // 폼 제출 전 검증
  document.querySelector('form').addEventListener('submit', function(e) {
    const categoryId = subSelect.value;

    if (!categoryId) {
      alert('카테고리를 모두 선택해주세요.');
      e.preventDefault();
      return;
    }
  });

  // ===== 이미지 업로드 로직 =====

  /**
   * 1단계: Presigned URL 요청 함수
   * 서버에 파일명과 타입을 보내면, S3 업로드용 임시 URL을 받아옴
   */
  async function getPresignedUrl(filename, contentType) {
    const formData = new FormData();
    formData.append('filename', filename);
    formData.append('contentType', contentType);

    const response = await fetch('/products/presigned-url', {
      method: 'POST',
      body: formData
    });

    if (!response.ok) {
      throw new Error('Presigned URL 요청 실패');
    }

    return await response.json();
  }

  /**
   * 2단계: S3에 직접 업로드 함수
   * Presigned URL을 사용해 S3에 파일을 PUT 요청으로 업로드
   */
  async function uploadToS3(uploadUrl, file, contentType) {
    const response = await fetch(uploadUrl, {
      method: 'PUT',
      body: file,
      headers: {
        'Content-Type': contentType
      }
    });

    if (!response.ok) {
      throw new Error('S3 업로드 실패');
    }
  }

  /**
   * 3단계: 메인 이미지 업로드 처리
   */
  document.getElementById('mainImage').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    try {
      console.log('메인 이미지 업로드 시작:', file.name);

      // 1. Presigned URL 요청
      const data = await getPresignedUrl(file.name, file.type);
      console.log('Presigned URL 받음:', data);

      // 2. S3에 업로드
      await uploadToS3(data.uploadUrl, file, file.type);
      console.log('S3 업로드 완료');

      // 3. key를 hidden input에 저장
      document.querySelector('input[name="mainImageKey"]').value = data.key;
      console.log('메인 이미지 key 저장:', data.key);

      alert('메인 이미지 업로드 완료!');
    } catch (error) {
      console.error('메인 이미지 업로드 실패:', error);
      alert('이미지 업로드에 실패했습니다: ' + error.message);
    }
  });

  /**
   * 4단계: 서브 이미지 업로드 처리 (여러 파일)
   */
  document.getElementById('subImages').addEventListener('change', async function(e) {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;

    if (files.length > 4) {
      alert('서브 이미지는 최대 4장까지만 업로드 가능합니다.');
      e.target.value = '';
      return;
    }

    try {
      console.log('서브 이미지 업로드 시작:', files.length + '장');

      const uploadedKeys = [];

      // 각 파일을 순차적으로 업로드
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        console.log(`${i + 1}번째 이미지 업로드 중:`, file.name);

        // 1. Presigned URL 요청
        const data = await getPresignedUrl(file.name, file.type);

        // 2. S3에 업로드
        await uploadToS3(data.uploadUrl, file, file.type);

        // 3. key 저장
        uploadedKeys.push(data.key);
        console.log(`${i + 1}번째 이미지 업로드 완료`);
      }

      // 4. 컨테이너 초기화하고 각 key마다 hidden input 생성
      const container = document.getElementById('subImageKeysContainer');
      container.innerHTML = ''; // 기존 input 제거

      uploadedKeys.forEach(key => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'subImageKeys';
        input.value = key;
        container.appendChild(input);
      });

      console.log('서브 이미지 key 저장:', uploadedKeys);

      alert(`서브 이미지 ${files.length}장 업로드 완료!`);
    } catch (error) {
      console.error('서브 이미지 업로드 실패:', error);
      alert('이미지 업로드에 실패했습니다: ' + error.message);
    }
  });
</script>
</body>
</html>
